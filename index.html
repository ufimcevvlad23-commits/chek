<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ß–µ–∫-–ª–∏—Å—Ç —Å–¥–µ–ª–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:16px}
    .item{margin:6px 0}
    #saveBtn{margin-top:12px;padding:10px 16px;border:0;border-radius:8px;background:#2fc6f6;color:#fff;cursor:pointer}
    .muted{color:#666}.ok{color:#0a7f2e}.err{color:#c00}
    .row{margin:8px 0}.small{font-size:12px}
  </style>
</head>
<body>
  <div id="state" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

  <div id="content" style="display:none">
    <div class="row small muted">
      –°–¥–µ–ª–∫–∞: <span id="dealLabel">‚Äî</span> ‚Ä¢ –ü–æ–ª–µ: <span id="fieldLabel">‚Äî</span>
    </div>

    <!-- —á–µ–∫–±–æ–∫—Å—ã -->
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞"> –ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –°–ù–ò–õ–°"> –ö–æ–ø–∏—è –°–ù–ò–õ–°</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ò–ù–ù"> –ö–æ–ø–∏—è –ò–ù–ù</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏"> –ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞"> –ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è"> –ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞"> –ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞</div>

    <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div id="status" class="muted" style="margin-top:8px"></div>
  </div>

<script>
(function(){
  // --- –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL ---
  const params = new URLSearchParams(location.search);
  const DEAL_ID = params.get('deal');                   // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  const FIELD   = params.get('field') || 'UF_CRM_CHECKLIST'; // –≤–∞—à UF_–∫–æ–¥

  const state = document.getElementById('state');
  const content = document.getElementById('content');
  const dealLabel = document.getElementById('dealLabel');
  const fieldLabel = document.getElementById('fieldLabel');
  const saveBtn = document.getElementById('saveBtn');
  const statusEl = document.getElementById('status');

  const qs = (sel)=>Array.from(document.querySelectorAll(sel));
  const getValues = () => qs('input[type="checkbox"]').filter(i=>i.checked).map(i=>i.value);
  const setValues = (arr)=>{
    const set = new Set((arr||[]).map(String));
    qs('input[type="checkbox"]').forEach(cb => cb.checked = set.has(cb.value));
  };

  function parseValue(v){
    if (v == null || v === '') return [];
    if (Array.isArray(v)) return v.map(String);
    try { const j = JSON.parse(v); return Array.isArray(j) ? j : [String(j)]; } catch(_){}
    if (String(v).includes(',')) return String(v).split(',').map(s=>s.trim()).filter(Boolean);
    return [String(v)];
  }
  function stringify(arr){ return JSON.stringify(arr || []); }

  async function load(){
    if (!DEAL_ID) { state.textContent = '–ù–µ –ø–µ—Ä–µ–¥–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä deal –≤ URL'; return; }
    dealLabel.textContent = DEAL_ID;
    fieldLabel.textContent = FIELD;

    state.textContent = '–ó–∞–≥—Ä—É–∂–∞—é –ø–æ–ª–µ —Å–¥–µ–ª–∫–∏‚Ä¶';
    const r = await fetch(`/api/deal-field?deal=${encodeURIComponent(DEAL_ID)}&field=${encodeURIComponent(FIELD)}`);
    const data = await r.json();
    if (!data.ok) {
      state.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–µ (–ø–æ–∫–∞ –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞). –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.';
    } else {
      setValues(parseValue(data.value));
      state.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ.';
    }
    state.style.display = 'none';
    content.style.display = 'block';
  }

  async function save(){
    const values = getValues();
    statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';

    const r = await fetch('/api/deal-field', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        deal: DEAL_ID,
        field: FIELD,
        value: stringify(values) // –ø–∏—à–µ–º –∫–∞–∫ JSON-—Å—Ç—Ä–æ–∫—É –≤ –ø–æ–ª–µ (—Ç–∏–ø "–°—Ç—Ä–æ–∫–∞")
      })
    });
    const data = await r.json();
    if (data.ok) statusEl.innerHTML = '<span class="ok">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>';
    else statusEl.innerHTML = '<span class="err">–û—à–∏–±–∫–∞: ' + (data.error || 'save_failed') + '</span>';
  }

  // –∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–∞—Ö (–º–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å)
  qs('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', save));
  document.getElementById('saveBtn').addEventListener('click', save);

  load();
})();
</script>
</body>
</html>
