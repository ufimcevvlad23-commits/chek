<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ß–µ–∫-–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#fff; --card:#fff; --muted:#6b7280; --ok:#0a7f2e; --err:#c00; --accent:#2fc6f6; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; padding:20px; background:var(--bg);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111827;
    }
    .card{
      max-width:720px; margin:0 auto; background:var(--card);
      border:1px solid var(--border); border-radius:16px; padding:20px;
      box-shadow:0 4px 16px rgba(0,0,0,.04);
    }
    h1{ margin:0 0 12px 0; font-size:18px }
    .sub{ color:var(--muted); margin-bottom:16px }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:10px 16px; margin-top:8px; }
    label{ display:flex; align-items:flex-start; gap:10px; cursor:pointer; user-select:none }
    input[type="checkbox"]{ margin-top:2px; width:18px; height:18px }
    .row{ margin-top:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{ background:var(--accent); color:#fff; border:0; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .muted{ color:var(--muted) } .ok{ color:var(--ok) } .err{ color:var(--err) }
    .toast{ min-height:20px }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px }
  </style>
</head>
<body>
  <div class="card">
    <h1>–ß–µ–∫-–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
    <div class="sub">–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.</div>

    <div class="grid" id="list">
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞"><span>–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –°–ù–ò–õ–°"><span>–ö–æ–ø–∏—è –°–ù–ò–õ–°</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –ò–ù–ù"><span>–ö–æ–ø–∏—è –ò–ù–ù</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏"><span>–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö"><span>–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞"><span>–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ"><span>–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏"><span>–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü"><span>–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞"><span>–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è"><span>–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è"><span>–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò"><span>–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º"><span>–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞"><span>–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞</span></label>
    </div>

    <div class="row">
      <button id="saveBtn" class="btn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="toast" class="toast muted"></span>
    </div>
    <div id="hint" class="hint" style="display:none"></div>
  </div>

<script>
(function(){
  // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é =====
  const DEFAULT_FIELD = 'UF_CRM_CHECKLIST'; // –∫–æ–¥ –ø–æ–ª—è-–°–¢–†–û–ö–ò (—Å—é–¥–∞ –ø–∏—à–µ–º JSON-–º–∞—Å—Å–∏–≤)

  // ‚Äî‚Äî‚Äî UI helpers
  var toast = document.getElementById('toast');
  var saveBtn = document.getElementById('saveBtn');
  var hint = document.getElementById('hint');
  var inputs = Array.from(document.querySelectorAll('#list input[type="checkbox"]'));

  function ok(m){ toast.className='toast ok'; toast.textContent=m; }
  function info(m){ toast.className='toast muted'; toast.textContent=m; }
  function err(m){ toast.className='toast err'; toast.textContent=m; }

  function toJSON(arr){ return JSON.stringify(arr || []); }
  function fromUnknown(v){
    if (v == null || v === '') return [];
    if (Array.isArray(v)) return v.map(String);
    try { var j = JSON.parse(v); return Array.isArray(j) ? j : [String(j)]; } catch(e){}
    if (String(v).includes(',')) return String(v).split(',').map(function(s){ return s.trim(); }).filter(Boolean);
    return [String(v)];
  }
  function apply(values){
    var set = new Set((values||[]).map(String));
    inputs.forEach(function(cb){ cb.checked = set.has(cb.value); });
  }
  function collect(){
    return inputs.filter(function(i){ return i.checked; }).map(function(i){ return i.value; });
  }

  // ===== –ù–∞–¥—ë–∂–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ DEAL_ID (—Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º hash) =====
  function getIdFromSearchParams(sp){
    return sp.get('deal') || sp.get('id') || sp.get('ID') || sp.get('deal_id') || sp.get('DEAL_ID') || '';
  }
  function detectDealId(){
    // 1) HASH –Ω–∞—à–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã: #deal=123, #id=123, #DEAL_ID=123, #entityId=DEAL_123, –ø—Ä–æ—Å—Ç–æ —Ü–∏—Ñ—Ä—ã
    var hashString = location.hash ? location.hash.substring(1) : '';
    var hs = new URLSearchParams(hashString);
    var id = getIdFromSearchParams(hs);
    if (!id) {
      var entity = hs.get('entityId') || hs.get('ENTITY_ID');
      if (entity) {
        var mE = String(entity).match(/DEAL[_-]?(\d+)/i);
        if (mE) id = mE[1];
      }
    }
    if (!id) {
      var mN = hashString.match(/(\d{3,})/);
      if (mN) id = mN[1];
    }
    if (id) return String(id);

    // 2) Query –Ω–∞—à–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ –≤—Å—è–∫–∏–π
    var qs = new URLSearchParams(location.search);
    id = getIdFromSearchParams(qs);
    if (id) return String(id);

    // 3) –ò–º—è —Ñ–∞–π–ª–∞: /index-123.html
    var mPath = location.pathname.match(/index[-_](\d+)\.html$/i);
    if (mPath) return mPath[1];

    // 4) document.referrer (–µ—Å–ª–∏ –Ω–µ –æ—Ç—Ä–µ–∑–∞–Ω)
    try {
      var ref = document.referrer || '';
      if (ref) {
        var u = new URL(ref);
        var q = u.searchParams;
        id = getIdFromSearchParams(q);
        if (id) return String(id);
        var m1 = u.pathname.match(/\/crm\/deal\/(?:details|show)\/(\d+)\//i);
        if (m1) return m1[1];
        var ent = q.get('entityId');
        if (ent) {
          var m2 = String(ent).match(/DEAL[_-]?(\d+)/i);
          if (m2) return m2[1];
        }
        var m3 = ref.match(/deal[_-]?id=(\d+)/i);
        if (m3) return m3[1];
      }
    } catch(e){}

    return '';
  }

  // ===== –ü–æ–ª–µ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –≤ hash: #field=UF_CRM_XXXX) =====
  function detectFieldCode(){
    var hashString = location.hash ? location.hash.substring(1) : '';
    var hs = new URLSearchParams(hashString);
    var f = hs.get('field') || '';
    if (f) return f;
    var qs = new URLSearchParams(location.search);
    f = qs.get('field') || '';
    return f || DEFAULT_FIELD;
  }

  var DEAL_ID = detectDealId();
  var FIELD_CODE = detectFieldCode();

  function haveID(){ return !!DEAL_ID; }

  // ‚Äî‚Äî‚Äî API
  function apiGet(){
    if (!haveID()) return Promise.resolve({ ok:false, error:'no_deal_id' });
    return fetch('/api/deal-field?deal=' + encodeURIComponent(DEAL_ID) + '&field=' + encodeURIComponent(FIELD_CODE))
      .then(function(r){ return r.json(); });
  }
  function apiSet(value){
    if (!haveID()) return Promise.resolve({ ok:false, error:'no_deal_id' });
    return fetch('/api/deal-field', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ deal: DEAL_ID, field: FIELD_CODE, value: value })
    }).then(function(r){ return r.json(); });
  }

  // ‚Äî‚Äî‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  function load(){
    if (!haveID()){
      saveBtn.disabled = true;
      hint.style.display = 'block';
      hint.innerHTML = 'ID —Å–¥–µ–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL –≤–∏–¥–∞ <b>#deal=#ID#</b> (–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ <b>&field=UF_CRM_‚Ä¶</b>).';
      return;
    }
    saveBtn.disabled = false;
    apiGet().then(function(data){
      if (data && data.ok) {
        apply(fromUnknown(data.value));
        info('–ó–∞–≥—Ä—É–∂–µ–Ω–æ.');
      } else {
        info(''); // –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ
      }
    }).catch(function(){ info(''); });
  }

  function save(){
    if (!haveID()) return;
    var payload = toJSON(collect());
    apiSet(payload).then(function(data){
      if (data && data.ok) ok('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      else err('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + (data && data.error ? data.error : 'unknown_error'));
    }).catch(function(){ err('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); });
  }

  // ‚Äî‚Äî‚Äî –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–¥–µ–±–∞—É–Ω—Å)
  var t = null;
  function autoSave(){
    if (!haveID()) return;
    if (t) clearTimeout(t);
    t = setTimeout(save, 600);
  }

  inputs.forEach(function(cb){ cb.addEventListener('change', autoSave); });
  saveBtn.addEventListener('click', save);

  // –°—Ç–∞—Ä—Ç
  load();
})();
</script>
</body>
</html>
