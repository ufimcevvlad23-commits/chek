<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ß–µ–∫-–ª–∏—Å—Ç —Å–¥–µ–ª–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#2fc6f6; --muted:#666; --ok:#0a7f2e; --err:#c00; }
    body{font-family:system-ui,Arial,sans-serif;margin:16px}
    .item{margin:6px 0}
    .row{margin:8px 0}
    .small{font-size:12px;color:var(--muted)}
    #saveBtn{margin-top:12px;padding:10px 16px;border:0;border-radius:8px;background:var(--primary);color:#fff;cursor:pointer}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div id="state" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

  <div id="content" style="display:none">
    <div class="row small">
      –°–¥–µ–ª–∫–∞: <span id="dealLabel">‚Äî</span> ‚Ä¢ –ü–æ–ª–µ: <span id="fieldLabel">‚Äî</span>
    </div>

    <!-- —á–µ–∫–±–æ–∫—Å—ã -->
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞"> –ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –°–ù–ò–õ–°"> –ö–æ–ø–∏—è –°–ù–ò–õ–°</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ò–ù–ù"> –ö–æ–ø–∏—è –ò–ù–ù</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏"> –ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞"> –ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è"> –ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞"> –ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞</div>

    <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div id="status" class="row small muted"></div>
  </div>

<script>
(function () {
  // ===== –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ =====
  const DEFAULT_FIELD = 'UF_CRM_CHECKLIST'; // –≤–∞—à UF_–∫–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  // =====================

  // --- —É—Ç–∏–ª–∏—Ç—ã ---
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const debounce = (fn, ms) => {
    let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
  };
  const parseValue = (v) => {
    if (v == null || v === '') return [];
    if (Array.isArray(v)) return v.map(String);
    try { const j = JSON.parse(v); return Array.isArray(j) ? j : [String(j)]; } catch(_){}
    if (String(v).includes(',')) return String(v).split(',').map(s=>s.trim()).filter(Boolean);
    return [String(v)];
  };
  const stringify = arr => JSON.stringify(arr || []);

  // --- –æ–ø—Ä–µ–¥–µ–ª—è–µ–º DEAL_ID –∏ FIELD ---
  const params = new URLSearchParams(location.search);
  let DEAL_ID = params.get('deal') || '';
  const FIELD   = params.get('field') || DEFAULT_FIELD;

  function detectDealIdFromReferrer() {
    try {
      const ref = document.referrer || '';
      if (!ref) return '';
      const u = new URL(ref);
      const q = u.searchParams;
      const byQ = q.get('deal_id') || q.get('ID') || q.get('id');
      if (byQ) return String(byQ);
      const m1 = u.pathname.match(/\/crm\/deal\/(?:details|show)\/(\d+)\//i);
      if (m1) return m1[1];
      const ent = q.get('entityId');                     // entityId=DEAL_123
      if (ent) { const m2 = String(ent).match(/DEAL[_-]?(\d+)/i); if (m2) return m2[1]; }
      const m3 = ref.match(/deal[_-]?id=(\d+)/i);
      if (m3) return m3[1];
      return '';
    } catch { return ''; }
  }
  if (!DEAL_ID) DEAL_ID = detectDealIdFromReferrer();

  // –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –∏ –≤—ã—Ö–æ–¥–∏–º
  if (!DEAL_ID) {
    document.body.innerHTML =
      '<div style="margin:16px;color:#444">–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Å–¥–µ–ª–∫–∏. ' +
      '–î–æ–±–∞–≤—å—Ç–µ –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä <b>?deal=#ID#</b> (–∏–ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ –≤–∏–¥–∂–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–¥–µ–ª–∫–∏).</div>';
    return;
  }

  // --- —ç–ª–µ–º–µ–Ω—Ç—ã ---
  const state = $('#state');
  const content = $('#content');
  const dealLabel = $('#dealLabel');
  const fieldLabel = $('#fieldLabel');
  const statusEl = $('#status');
  const saveBtn = $('#saveBtn');

  dealLabel.textContent = DEAL_ID;
  fieldLabel.textContent = FIELD;

  // --- —Ä–∞–±–æ—Ç–∞ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ ---
  const getValues = () => $$('input[type="checkbox"]').filter(i=>i.checked).map(i=>i.value);
  const setValues = (arr) => {
    const set = new Set((arr||[]).map(String));
    $$('input[type="checkbox"]').forEach(cb => cb.checked = set.has(cb.value));
  };

  async function apiGet() {
    const url = `/api/deal-field?deal=${encodeURIComponent(DEAL_ID)}&field=${encodeURIComponent(FIELD)}`;
    const r = await fetch(url, { method:'GET' });
    return r.json();
  }
  async function apiSet(value) {
    const r = await fetch('/api/deal-field', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ deal: DEAL_ID, field: FIELD, value })
    });
    return r.json();
  }

  async function load() {
    try {
      state.textContent = '–ó–∞–≥—Ä—É–∂–∞—é –ø–æ–ª–µ —Å–¥–µ–ª–∫–∏‚Ä¶';
      const data = await apiGet();
      if (data.ok) {
        setValues(parseValue(data.value));
        state.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ.';
      } else {
        // –ø–æ–ª–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ ‚Äî —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞ UI
        state.textContent = '–ü–æ–ª–µ –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ. –ú–æ–∂–µ—Ç–µ –æ—Ç–º–µ—Ç–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.';
      }
    } catch (e) {
      state.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Äî –æ–Ω–æ —Å–æ–∑–¥–∞—Å—Ç—Å—è.';
    }
    state.style.display = 'none';
    content.style.display = 'block';
  }

  async function save() {
    try {
      statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
      const payload = stringify(getValues());           // –ø–∏—à–µ–º JSON-—Å—Ç—Ä–æ–∫—É –≤ –ø–æ–ª–µ (—Ç–∏–ø "–°—Ç—Ä–æ–∫–∞")
      const data = await apiSet(payload);
      if (data.ok) statusEl.innerHTML = '<span class="ok">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>';
      else statusEl.innerHTML = '<span class="err">–û—à–∏–±–∫–∞: ' + (data.error || 'save_failed') + '</span>';
    } catch (e) {
      statusEl.innerHTML = '<span class="err">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</span>';
    }
  }

  // –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –¥–µ–±–∞—É–Ω—Å–æ–º
  const autoSave = debounce(save, 600);
  $$('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', autoSave));
  saveBtn.addEventListener('click', save);

  // —Å—Ç–∞—Ä—Ç
  load();
})();
</script>
</body>
</html>
