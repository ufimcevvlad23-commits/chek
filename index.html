<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ß–µ–∫-–ª–∏—Å—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#fff; --card:#fff; --muted:#6b7280; --ok:#0a7f2e; --err:#c00; --accent:#2fc6f6; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; padding:20px; background:var(--bg); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111827; }
    .card{ max-width:720px; margin:0 auto; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 4px 16px rgba(0,0,0,.04); }
    h1{ margin:0 0 12px 0; font-size:18px }
    .sub{ color:var(--muted); margin-bottom:16px }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:10px 16px; margin-top:8px; }
    label{ display:flex; align-items:flex-start; gap:10px; cursor:pointer; user-select:none }
    input[type="checkbox"]{ margin-top:2px; width:18px; height:18px }
    .row{ margin-top:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{ background:var(--accent); color:#fff; border:0; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .muted{ color:var(--muted) } .ok{ color:var(--ok) } .err{ color:var(--err) }
    .toast{ min-height:20px }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px }
  </style>
</head>
<body>
  <div class="card">
    <h1>–ß–µ–∫-–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
    <div id="subtitle" class="sub">–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.</div>

    <div class="grid" id="list">
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞"><span>–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –°–ù–ò–õ–°"><span>–ö–æ–ø–∏—è –°–ù–ò–õ–°</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –ò–ù–ù"><span>–ö–æ–ø–∏—è –ò–ù–ù</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏"><span>–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö"><span>–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞"><span>–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ"><span>–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏"><span>–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü"><span>–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞"><span>–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è"><span>–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è"><span>–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò"><span>–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º"><span>–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º</span></label>
      <label><input type="checkbox" value="–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞"><span>–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞</span></label>
    </div>

    <div class="row">
      <button id="saveBtn" class="btn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="toast" class="toast muted"></span>
    </div>
    <div id="hint" class="hint" style="display:none"></div>
  </div>

<script>
(() => {
  const FIELD_CODE = 'UF_CRM_CHECKLIST';   // –∫–æ–¥ –ø–æ–ª—è-–°–¢–†–û–ö–ò (—Ö—Ä–∞–Ω–∏–º JSON-–º–∞—Å—Å–∏–≤)
  const AUTOSAVE_MS = 600;

  const toast = document.getElementById('toast');
  const saveBtn = document.getElementById('saveBtn');
  const hint = document.getElementById('hint');
  const inputs = Array.from(document.querySelectorAll('#list input[type="checkbox"]'));

  const ok  = m => { toast.className='toast ok'; toast.textContent=m; };
  const info= m => { toast.className='toast muted'; toast.textContent=m; };
  const err = m => { toast.className='toast err'; toast.textContent=m; };

  const toJSON = arr => JSON.stringify(arr || []);
  const fromUnknown = v => {
    if (v == null || v === '') return [];
    if (Array.isArray(v)) return v.map(String);
    try { const j = JSON.parse(v); return Array.isArray(j) ? j : [String(j)]; } catch {}
    if (String(v).includes(',')) return String(v).split(',').map(s=>s.trim()).filter(Boolean);
    return [String(v)];
  };
  const apply = values => {
    const set = new Set((values||[]).map(String));
    inputs.forEach(cb => cb.checked = set.has(cb.value));
  };
  const collect = () => inputs.filter(i=>i.checked).map(i=>i.value);

  // ===== —Å–≤–µ—Ä—Ö–Ω–∞–¥—ë–∂–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ DEAL_ID =====
  function getFromQS(sp) {
    return sp.get('deal') || sp.get('id') || sp.get('ID') || sp.get('deal_id') || '';
  }
  function detectDealId() {
    // 1) query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—à–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (?deal=#ID# ‚Äî –µ—Å–ª–∏ –∫–æ–≥–¥–∞-—Ç–æ –¥–æ–±–∞–≤–∏–º)
    const qs = new URLSearchParams(location.search);
    let id = getFromQS(qs);
    if (id) return id;

    // 2) hash (#deal=123)
    const hs = new URLSearchParams(location.hash.replace(/^#/, ''));
    id = getFromQS(hs);
    if (id) return id;

    // 3) document.referrer: query
    try {
      const ref = document.referrer || '';
      if (ref) {
        const u = new URL(ref);
        const q = new URLSearchParams(u.search);
        id = getFromQS(q);
        if (id) return id;

        // 4) document.referrer: path /crm/deal/details/123/
        const m1 = u.pathname.match(/\/crm\/deal\/(?:details|show)\/(\d+)\//i);
        if (m1) return m1[1];

        // 5) entityId=DEAL_123
        const ent = q.get('entityId');
        if (ent) {
          const m2 = String(ent).match(/DEAL[_-]?(\d+)/i);
          if (m2) return m2[1];
        }

        // 6) –≥—Ä—É–±—ã–π –ø–æ–∏—Å–∫ –≤ –ø–æ–ª–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
        const m3 = ref.match(/deal[_-]?id=(\d+)/i);
        if (m3) return m3[1];
      }
    } catch {}

    // 7) –∏–Ω–æ–≥–¥–∞ Bitrix –∫–ª–∞–¥—ë—Ç JSON –≤ window.name
    try {
      const wn = (window.name || '').trim();
      if (wn.startsWith('{') || wn.startsWith('[')) {
        const obj = JSON.parse(wn);
        const cand = obj.deal || obj.id || obj.ID || obj.deal_id;
        if (cand) return String(cand);
      }
    } catch {}

    return '';
  }

  let DEAL_ID = detectDealId();
  const haveID = () => !!DEAL_ID;

  async function apiGet() {
    if (!haveID()) return { ok:false, error:'no_deal_id' };
    const r = await fetch(`/api/deal-field?deal=${encodeURIComponent(DEAL_ID)}&field=${encodeURIComponent(FIELD_CODE)}`);
    return r.json();
  }
  async function apiSet(value) {
    if (!haveID()) return { ok:false, error:'no_deal_id' };
    const r = await fetch('/api/deal-field', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ deal: DEAL_ID, field: FIELD_CODE, value })
    });
    return r.json();
  }

  async function load() {
    if (!haveID()) {
      // ID –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±—ã—Ç—å => Bitrix —Ä–µ–∂–µ—Ç referrer –¥–æ origin.
      // UI –æ—Å—Ç–∞—ë—Ç—Å—è —Ä–∞–±–æ—á–∏–º (–±–µ–∑ –æ—à–∏–±–æ–∫), –Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–∞–µ–º.
      saveBtn.disabled = true;
      hint.style.display = 'block';
      hint.innerHTML = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Å–¥–µ–ª–∫–∏ –∏–∑ Bitrix (—Ä–µ—Ñ–µ—Ä–µ—Ä —Å–∫—Ä—ã—Ç). ' +
        '–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ –≤ URL –≤–∫–ª–∞–¥–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä <b>?deal=#ID#</b> ' +
        '–∏–ª–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–µ—Ä –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–æ—Ä—Ç–∞–ª–∞.';
      return;
    }

    // —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≥—Ä—É–∑–∏—Ç—å/—Å–æ—Ö—Ä–∞–Ω—è—Ç—å
    saveBtn.disabled = false;

    try {
      const data = await apiGet();
      if (data.ok) {
        apply(fromUnknown(data.value));
        info('–ó–∞–≥—Ä—É–∂–µ–Ω–æ.');
      } else {
        // –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ ‚Äî —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞
        info('');
      }
    } catch {
      info('');
    }
  }

  async function save() {
    if (!haveID()) return; // safety
    const payload = toJSON(collect());
    try {
      const data = await apiSet(payload);
      if (data.ok) ok('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      else err('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + (data.error || 'unknown_error'));
    } catch {
      err('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
  }

  // –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ ID –Ω–∞–π–¥–µ–Ω
  let t;
  const autoSave = () => {
    if (!haveID()) return;
    clearTimeout(t); t = setTimeout(save, AUTOSAVE_MS);
  };
  inputs.forEach(cb => cb.addEventListener('change', autoSave));
  saveBtn.addEventListener('click', save);

  load();
})();
</script>
</body>
</html>
