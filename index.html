<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß–µ–∫-–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .item { margin: 5px 0; }
  </style>
  <script src="https://api.bitrix24.com/api/v1/"></script>
</head>
<body>
  <h2>üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
  <div id="checklist"></div>

  <script>
    // –°–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤
    const items = [
      "–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞",
      "–ö–æ–ø–∏—è –°–ù–ò–õ–°",
      "–ö–æ–ø–∏—è –ò–ù–ù",
      "–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏",
      "–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö",
      "–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞",
      "–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ",
      "–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏",
      "–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü",
      "–ö–≤–∏—Ç–∞–Ω—Ü–∏—è –æ –≤–Ω–µ—Å–µ–Ω–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞ —Å—É–¥–∞",
      "–ö–≤–∏—Ç–∞–Ω—Ü–∏—è –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è",
      "–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏",
      "–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –ù–ë–ö–ò",
      "–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º",
      "–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç—É ‚Ññ___",
      "–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞"
    ];

    let dealId;
    let checklistData = {};

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–¥–µ–ª–∫–∏
    BX24.init(() => {
      dealId = BX24.placement.info().options.dealId;

      BX24.callMethod(
        "crm.deal.get",
        { id: dealId },
        result => {
          if (result.error()) {
            console.error(result.error());
          } else {
            const deal = result.data();
            checklistData = deal.UF_CRM_1758827061 ? JSON.parse(deal.UF_CRM_1758827061) : {};
            renderChecklist();
          }
        }
      );
    });

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–µ–∫-–ª–∏—Å—Ç–∞
    function renderChecklist() {
      const container = document.getElementById("checklist");
      container.innerHTML = "";

      items.forEach((label, i) => {
        const checked = checklistData[i] || false;
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<input type="checkbox" id="chk${i}" ${checked ? "checked" : ""}> ${label}`;
        container.appendChild(div);

        document.getElementById(`chk${i}`).addEventListener("change", e => {
          checklistData[i] = e.target.checked;
          saveChecklist();
        });
      });
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ–∫-–ª–∏—Å—Ç–∞ –≤ —Å–¥–µ–ª–∫—É
    function saveChecklist() {
      BX24.callMethod(
        "crm.deal.update",
        {
          id: dealId,
          fields: {
            "UF_CRM_1758827061": JSON.stringify(checklistData)
          }
        },
        res => {
          if (res.error()) console.error(res.error());
          else console.log("Checklist saved");
        }
      );
    }
  </script>
</body>
</html>
