<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ß–µ–∫-–ª–∏—Å—Ç —Å–¥–µ–ª–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:16px}
    .item{margin:6px 0}
    #saveBtn{margin-top:12px;padding:10px 16px;border:0;border-radius:8px;background:#2fc6f6;color:#fff;cursor:pointer}
    .muted{color:#666}
    .ok{color:#0a7f2e}
    .err{color:#c00}
  </style>
  <script src="https://api.bitrix24.com/api/v1/"></script>
</head>
<body>
  <div id="state" class="muted">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>

  <div id="content" style="display:none">
    <div class="muted" id="dealInfo">–°–¥–µ–ª–∫–∞ ‚Äî</div>

    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞"> –ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –°–ù–ò–õ–°"> –ö–æ–ø–∏—è –°–ù–ò–õ–°</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ò–ù–ù"> –ö–æ–ø–∏—è –ò–ù–ù</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏"> –ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞"> –ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è"> –ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞"> –ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞</div>

    <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div id="status" class="muted" style="margin-top:8px"></div>
  </div>

<script>
(function(){
  const FIELD = 'UF_CRM_CHECKLIST'; // <-- –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à UF_CRM_xxxxx (—Ç–∏–ø "–°—Ç—Ä–æ–∫–∞")
  const state = document.getElementById('state');
  const content = document.getElementById('content');
  const dealInfo = document.getElementById('dealInfo');
  const statusEl = document.getElementById('status');
  const saveBtn = document.getElementById('saveBtn');
  let DEAL_ID = null;

  const qs = (sel)=>Array.from(document.querySelectorAll(sel));

  function setStatus(msg, cls=''){ statusEl.className = cls; statusEl.textContent = msg; }

  function getValues(){
    return qs('input[type="checkbox"]').filter(i=>i.checked).map(i=>i.value);
  }
  function applyValues(arr){
    const set = new Set((arr||[]).map(String));
    qs('input[type="checkbox"]').forEach(i=> i.checked = set.has(i.value));
  }
  function parseStored(v){
    if (v == null || v === '') return [];
    // –ø—Ä–æ–±—É–µ–º JSON -> –∏–Ω–∞—á–µ CSV -> –∏–Ω–∞—á–µ –æ–¥–∏–Ω–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    try { const j = JSON.parse(v); return Array.isArray(j) ? j : [String(j)]; } catch(_){}
    if (String(v).includes(',')) return String(v).split(',').map(s=>s.trim()).filter(Boolean);
    return [String(v)];
  }

  function init(){
    if (!window.BX24){ state.textContent='–ù–µ—Ç SDK Bitrix24'; return; }
    BX24.init(function(){
      state.textContent='–ü–æ–ª—É—á–∞—é –∫–æ–Ω—Ç–µ–∫—Å—Ç‚Ä¶';
      BX24.placement.info(function(ctx){
        DEAL_ID = ctx?.options?.ID ? Number(ctx.options.ID) : null;
        if(!DEAL_ID){ state.textContent='–ù–µ –Ω–∞–π–¥–µ–Ω ID —Å–¥–µ–ª–∫–∏ –≤ placement'; return; }
        loadDeal();
      });
    });
  }

  function loadDeal(){
    state.textContent='–ó–∞–≥—Ä—É–∂–∞—é —Å–¥–µ–ª–∫—É #' + DEAL_ID + '‚Ä¶';
    BX24.callMethod('crm.deal.get', { id: DEAL_ID }, function(res){
      if(res.error()){ state.textContent = '–û—à–∏–±–∫–∞: ' + res.error(); return; }
      const deal = res.answer.result;
      dealInfo.textContent = `–°–¥–µ–ª–∫–∞ #${DEAL_ID} ‚Äî ${deal.TITLE || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}`;
      applyValues(parseStored(deal[FIELD]));
      state.style.display='none';
      content.style.display='block';
    });
  }

  saveBtn.addEventListener('click', function(){
    const values = getValues();
    setStatus('–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶', 'muted');

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ JSON –≤ —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø–æ–ª–µ
    const fields = {}; fields[FIELD] = JSON.stringify(values);

    BX24.callMethod('crm.deal.update', { id: DEAL_ID, fields }, function(res){
      if(res.error()){ setStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + res.error(), 'err'); return; }
      setStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'ok');
    });
  });

  init();
})();
</script>
</body>
</html>
