<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ß–µ–∫-–ª–∏—Å—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:16px}
    .item{margin:6px 0}
    #saveBtn{margin-top:12px;padding:10px 16px;border:0;border-radius:8px;background:#2fc6f6;color:#fff;cursor:pointer}
    .muted{color:#666}
    .ok{color:#0a7f2e}
    .err{color:#c00}
    .row{margin:8px 0}
    code{background:#f3f3f3;padding:2px 6px;border-radius:6px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div id="state" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

  <div id="content" style="display:none">
    <div class="row small muted">
      –°–¥–µ–ª–∫–∞: <span id="dealLabel">‚Äî</span><br>
      –ü–æ–ª–µ: <span id="fieldLabel">‚Äî</span>
    </div>

    <!-- –ß–ï–ö–ë–û–ö–°–´ ‚Äî –∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏ -->
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞"> –ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –°–ù–ò–õ–°"> –ö–æ–ø–∏—è –°–ù–ò–õ–°</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ò–ù–ù"> –ö–æ–ø–∏—è –ò–ù–ù</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏"> –ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞"> –ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è"> –ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞"> –ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞</div>

    <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div id="status" class="muted" style="margin-top:8px"></div>

    <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏/–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <input type="hidden" id="UF_DYNAMIC_FIELD" value="">
    <div class="row small muted">
      –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è: <code id="mirror"></code>
      <div class="small">–¢–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ <code>location.hash</code> –∏ –≤ <code>document.title</code>.</div>
    </div>
  </div>

<script>
(function(){
  // ===== –ù–ê–°–¢–†–û–ô–ö–ò –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ =====
  const DEFAULT_FIELD = 'UF_CRM_CHECKLIST'; // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –≤–∞—à –∫–æ–¥ –ø–æ–ª—è
  // ===================================

  const state = document.getElementById('state');
  const content = document.getElementById('content');
  const statusEl = document.getElementById('status');
  const saveBtn = document.getElementById('saveBtn');
  const mirror = document.getElementById('mirror');
  const hiddenField = document.getElementById('UF_DYNAMIC_FIELD');
  const dealLabel = document.getElementById('dealLabel');
  const fieldLabel = document.getElementById('fieldLabel');

  const params = new URLSearchParams(location.search);
  const DEAL_ID = params.get('deal') || '';            // ID —Å–¥–µ–ª–∫–∏ (–¥–ª—è –∫–ª—é—á–∞ localStorage)
  const FIELD = params.get('field') || DEFAULT_FIELD;  // –∫–æ–¥ –ø–æ–ª—è
  const URL_VALUE = params.get('value');               // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ URL (JSON –∏–ª–∏ CSV)

  dealLabel.textContent = DEAL_ID || '‚Äî';
  fieldLabel.textContent = FIELD;

  function qs(sel){ return Array.from(document.querySelectorAll(sel)); }

  function setStatus(msg, cls){
    statusEl.className = cls || 'muted';
    statusEl.textContent = msg;
  }

  function encodeTitle(s){
    try { return btoa(unescape(encodeURIComponent(s))).slice(0,200); }
    catch { return s.slice(0,200); }
  }

  function getChecked(){
    return qs('input[type="checkbox"]').filter(i=>i.checked).map(i=>i.value);
  }

  function setChecked(values){
    const set = new Set((values||[]).map(String));
    qs('input[type="checkbox"]').forEach(i => { i.checked = set.has(i.value); });
  }

  function parseValue(v){
    if (v == null || v === '') return [];
    try { const j = JSON.parse(v); return Array.isArray(j) ? j : [String(j)]; } catch(_){}
    if (String(v).includes(',')) return String(v).split(',').map(s=>s.trim()).filter(Boolean);
    return [String(v)];
  }

  function stringify(values){
    // –•—Ä–∞–Ω–∏–º –∫–∞–∫ JSON (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –∏ –±–µ–∑ –ø–æ—Ç–µ—Ä—å)
    return JSON.stringify(values);
  }

  function storageKey(){
    return 'checklist:' + (DEAL_ID || 'default') + ':' + FIELD;
    }
  function loadInitial(){
    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ?value=... -> localStorage -> –ø—É—Å—Ç–æ
    if (URL_VALUE && URL_VALUE.trim() !== '') return parseValue(URL_VALUE);
    const raw = localStorage.getItem(storageKey());
    return parseValue(raw);
  }

  function syncOutputs(values){
    const str = stringify(values);
    hiddenField.id = FIELD;             // –ø–æ–¥–º–µ–Ω—è–µ–º id —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–¥
    hiddenField.value = str;            // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è (–º–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)
    mirror.textContent = str;           // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    location.hash = 'value=' + encodeURIComponent(str); // —á—Ç–æ–±—ã –≤–Ω–µ—à–∫–∞ –º–æ–≥–ª–∞ —Å—á–∏—Ç–∞—Ç—å –±–µ–∑ SDK
    document.title = encodeTitle(str);  // –∫–æ—Ä–æ—Ç–∫–∞—è ¬´—Å–∏–≥–Ω–∞—Ç—É—Ä–∞¬ª –≤ title
  }

  function save(values){
    const str = stringify(values);
    localStorage.setItem(storageKey(), str); // –ø–µ—Ä-—Å–¥–µ–ª–æ—á–Ω—ã–π –∫–µ—à
    syncOutputs(values);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  const startValues = loadInitial();
  setChecked(startValues);
  syncOutputs(startValues);

  state.style.display = 'none';
  content.style.display = 'block';
  setStatus('–ì–æ—Ç–æ–≤–æ', 'ok');

  // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å (–ø–æ —Ñ–∞–∫—Ç—É ‚Äî —Ñ–æ—Ä—Å–∏—Ä—É–µ–º –∑–∞–ø–∏—Å—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å)
  saveBtn.addEventListener('click', () => {
    const values = getChecked();
    save(values);
    setStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ ‚Ä¢ –ø–æ–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Ä¢ hash/title –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'ok');
  });

  // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–∞ –ª–µ—Ç—É –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ —á–µ–∫–±–æ–∫—Å—É
  qs('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      save(getChecked());
      setStatus('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶', 'muted');
    });
  });

})();
</script>
</body>
</html>
