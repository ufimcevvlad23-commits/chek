<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f4f6f8;
    }
    h2 {
      color: #333;
      margin-bottom: 20px;
    }
    #checklist {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 480px;
    }
    .item {
      margin-bottom: 10px;
      font-size: 15px;
      display: flex;
      align-items: center;
    }
    input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    button {
      margin-top: 15px;
      background: #0d6efd;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
    }
    button:hover {
      background: #0b5ed7;
    }
    .status {
      margin-top: 15px;
      font-weight: bold;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
  <div id="checklist">
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞"> –ö–æ–ø–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –°–ù–ò–õ–°"> –ö–æ–ø–∏—è –°–ù–ò–õ–°</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ò–ù–ù"> –ö–æ–ø–∏—è –ò–ù–ù</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏"> –ö–æ–ø–∏—è —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –æ –±—Ä–∞–∫–µ/—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –≠–¢–ö</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞"> –ö–æ–ø–∏—è –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ 2-–ù–î–§–õ</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—É–¥–∏–º–æ—Å—Ç–∏</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü"> –ö–æ–ø–∏—è —Å–ø—Ä–∞–≤–∫–∏ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–ü</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å—É–¥–∞</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è"> –ö–æ–ø–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–ª–µ–Ω–∏—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è"> –ö–æ–ø–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –û–ö–ë/–ù–ë–ö–ò</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º"> –ö–æ–ø–∏—è –≤—ã–ø–∏—Å–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º</div>
    <div class="item"><input type="checkbox" value="–ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞"> –ö–æ–ø–∏—è –±—Ä–∞—á–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞</div>
    <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div class="status" id="status"></div>
  </div>

  <script>
    // === ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
    const webhook = "https://nta-company.bitrix24.ru/rest/56435/tkhvw3wzcpj80s54/"; // —Ç–≤–æ–π –≤–µ–±—Ö—É–∫
    const fieldCode = "UF_CRM_1758827061"; // –ø–æ–ª–µ, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —á–µ–∫-–ª–∏—Å—Ç
    const defaultDealId = 42; // –∑–∞–ø–∞—Å–Ω–æ–π ID, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω

    // === ‚öôÔ∏è –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
    const statusEl = document.getElementById("status");

    function showStatus(msg, ok = true) {
      statusEl.textContent = msg;
      statusEl.style.color = ok ? "green" : "red";
    }

    function getChecklistData() {
      const boxes = document.querySelectorAll('input[type="checkbox"]');
      return Array.from(boxes).map(b => ({ name: b.value, checked: b.checked }));
    }

    function setChecklistData(data) {
      if (!data) return;
      const boxes = document.querySelectorAll('input[type="checkbox"]');
      data.forEach((item, idx) => {
        if (boxes[idx]) boxes[idx].checked = item.checked;
      });
    }

    async function getDealData(dealId) {
      try {
        const res = await fetch(`${webhook}crm.deal.get.json`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ id: dealId })
        });
        const data = await res.json();
        return data.result;
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ getDealData:", e);
        return null;
      }
    }

    async function updateDealField(dealId, field, value) {
      try {
        const res = await fetch(`${webhook}crm.deal.update.json`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            id: dealId,
            [`fields[${field}]`]: value
          })
        });
        return await res.json();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ updateDealField:", e);
      }
    }

    // === üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
    async function loadChecklist() {
      const params = new URLSearchParams(window.location.search);
      const dealId = params.get("deal_id") || defaultDealId;

      showStatus("‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...");

      const deal = await getDealData(dealId);
      if (!deal) return showStatus("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏", false);

      try {
        const savedData = JSON.parse(deal[fieldCode]);
        if (savedData) setChecklistData(savedData);
        showStatus("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ");
      } catch {
        showStatus("‚ö†Ô∏è –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö");
      }
    }

    async function saveChecklist() {
      const params = new URLSearchParams(window.location.search);
      const dealId = params.get("deal_id") || defaultDealId;
      const data = JSON.stringify(getChecklistData());

      const result = await updateDealField(dealId, fieldCode, data);
      if (result?.result) showStatus("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
      else showStatus("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", false);
    }

    document.getElementById("saveBtn").addEventListener("click", saveChecklist);
    window.onload = loadChecklist;
  </script>
</body>
</html>
